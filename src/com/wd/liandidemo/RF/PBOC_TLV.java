package com.wd.liandidemo.RF;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import cn.wonders.pos_qdg.util.LogUtil;
import cn.wonders.pos_qdg.util.StringUtils;

public class PBOC_TLV {

    private static String CardNumber;

	//eg. tlv="9F36020B889F270180" return {9F27=80, 9F36=0B88}
    public static Map decodingTLV(List list) {
        Map map = new HashMap();
        for(int i = 0; i < list.size(); i++) {
            String[] tlv = (String[]) list.get(i);
            map.put(tlv[0], tlv[2]);
        }
        return map;
    }

    //eg. tlv="9F36020B889F270180" return {[9F36,02,0B88], [9F27,01,80]}
    public static List decodingTLV(String str) {
        if (str == null || str.length() % 2 != 0) {
            throw new RuntimeException("Invalid tlv, null or odd length");
        }
        List ls = new ArrayList();
        for (int i = 0; i < str.length();) {
            try {
                String tag = str.substring(i, i = i + 2);
                // extra byte for TAG field
                if ((Integer.parseInt(tag, 16) & 0x1F) == 0x1F) {
                    tag += str.substring(i, i = i + 2);
                }
                String len = str.substring(i, i = i + 2);
                int length = Integer.parseInt(len, 16);
                // more than 1 byte for length
                if (length > 128) {//临界值，当是128即10000000时，长度还是一位，而不是两位
                    int bytesLength = length - 128;
                    	len = str.substring(i, i = i + (bytesLength * 2));
                    	if (StringUtils.checkHexNum(len)&&len.length()<=2) {
                    		LogUtil.i("len数值： "+len);
                    		length = Integer.parseInt(len, 16);
						}else{
							LogUtil.e("读卡时出现错误，消费失败");
							return null;
						}
                }
//                if (length > 128) {//临界值，当是128即10000000时，长度还是一位，而不是两位
//                	int bytesLength = length - 128;
//                	len = str.substring(i, i = i + (bytesLength * 2));
//                	length = Integer.parseInt(len, 16);
//                }
                length *= 2;
                String value = str.substring(i, i = i + length);
                LogUtil.i("tag:" + tag + " len:" + len + " value:" + value);
                ls.add(new String[] {tag, len, value});
            } catch (NumberFormatException e) {
                throw new RuntimeException("Error parsing number", e);
            } catch (IndexOutOfBoundsException e) {
                throw new RuntimeException("Error processing field", e);
            }
        }
        return ls;
    }

    public static String encodingTLV(Map tlvMap) {
        String str = "";
        Iterator iter = tlvMap.entrySet().iterator();
        String tag = "";
        String length = "";
        String value = "";
        Entry entry;
        while (iter.hasNext()) {
            entry = (Entry) iter.next();
            tag = (String) entry.getKey();
            value = (String) entry.getValue();
            length = String.valueOf(Integer.parseInt(String.valueOf(value.length() / 2), 16));
            str += tag + length + value;
        }
        return str;
    }

    public static String encodingTLV(List tlvList) {
        String str = "";
        for(int i = 0; i < tlvList.size(); i++) {
            String[] tlv = (String[]) tlvList.get(i);
            str += tlv[0] + tlv[1] + tlv[2];
        }
        return str;
    }

    public static void main(String[] args) {
//        String ss = "82027C00940C1801060130010100200202009F360200FB9F260884727BA346DB7C439F101307010103900000010A01000002129948D3E53857136231700190000013539D26012200000000724F5F3401019F6C0200009000";
        String ss = "50DF1140000000001E000000000000000000000033DF11400000000054751C4064751C400000000028021D4020616E00726F69643A3A5246000000005379737454FBB0BE45495F75634F70656E52464361726444FCF4B0BE00000000000000006F6E73742A2C2075696E742C2044657648616E646C652A2C20617070696E666F290A000089E00D403B8C0D403CF5B0BE50DF114002000000EBF6B0BE01000000040000000CF5B0BE010000003B8C0D40070000003CF5B0BE2500000028021D403B8C0D40040000004FE30D4054F9B0BE4150492045415F75634F70656E5246436172644465766963652069732063616C6C65640A000000000000000094FCB0BE18F6B0BE0000000018F6B0BE02000000ABC60C40010000005CF6B0BE94FCB0BEFFFFFFFFDFFFFFFFD7481A401001B1BEFD5A1A40000000000000000000000000000000009450834073000000E4F5B0BE0000000021000000AAC60C40889D7601220000000000000000000000A8C60C400000000054751C4064751C400000000028021D400800000000000000309E76010000000060F7B0BE0C01B1BE0800000060F7B0BE8C5083407D0C444054F6B0BE0000000000000000000000000572000000000000309E760159E14340000000004DDA4340309E7601E30E4440909E7601609E760100632840AAC60C40010000000000000000000000000000000000000008000000000000008C50834094508340FB9C5CBE00000000309E760160F7B0BE1000000005000000FB9C5CBE0100000000000000000000000000000000000000080200003B8C0D400400000069211140EC05B1BE0000000028021D407C0BB1BE77651A40000000C00000000000000000282877010040000093F7B0BE00000032B0030000030000000900000089E00D403B8C0D4044F7B0BE0000000069211140B7E10D40309E76010400000014F7B0BE010000003B8C0D400700000044F7B0BE5000000028021D403B8C0D40040000004FE30D405CFBB0BE63616C6C2066756E63203A766F696420616E64726F69643A3A52466361726453797374656D3A3A45495F76536574524643616C6C6261636B286465766963655F63616C6C6261636B5F66756E63290A006D7D0D4034F8B0BEAB6B0D40A38B0D40737D0D406F735F71646700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FB9C5CBE0CFFB0BE0000000000000000000000000000000008020000A0C60C4004000000630A0000EC05B1BE0000000028021D407C0BB1BE77651A4000000000000000000000000077651A4000400000EAF8B0BE00000000A10300000C000000090000005D3A1340A0C60C408CF8B0BE00000000630A00008B3B13409CF8B0BE040000005CF8B0BE01000000A0C60C40080000008CF8B0BE5F00000028021D40A0C60C4004000000233D1340A4FCB0BE20232323232323232323232320205245515545535420207C202073203732207C207069642032363539207469642031393930207C20636E2E776F6E646572732E706F735F716467207C20616374696F6E20636F6465205B30783231315D0A0000000000000000000008000000000000008050834088508340FB9C5CBE00000000309E7601E8F9B0BE10000000050000000000000002000000B8F9B0BE7C0BB1BEBBE2434002000000B8F9B0BE000000006D1F1940080000000000000074F9B0BE22770000985083400000000084F9B0BE2277000000000000F3264440889D760184F9B0BE00FBB0BE07C2434000000000050C444000FBB0BE289D76010000000000FBB0BE0400000000000000309E7601290C444000FBB0BE945083400400000000FBB0BE945083407D0C444000000000309E760100FBB0BE000000000572000000000000309E760159E14340000000004DDA4340309E7601E30E4440909E7601609E76010063284000000000000000000000000000000000000000000000000004000000000000009450834098508340FB9C5CBE00000000309E760100FBB0BE10000000050000000000000020000000D0FAB0BE7C0BB1BEBBE2434020000000D0FAB0BE120000003D9D4940C223770198D4760188D476012FB64940000000000BBE4940889D760128021D4008FCB0BE07C24340E8FDB0BEC4FDB0BE3100000057B81F400100000025FCB0BEC4FDB0BEBB372040C4FDB0BE01FDB0BEC4FDB0BE01FDB0BE68FCB0BE4CFBB0BE68FCB0BE2D00000021FCB0BE4CFBB0BE000000001DA1204004000000C4FDB0BE01FDB0BE2D00000042FCB0BE6CFBB0BE000000001DA120400100B1BE8800B1BE0100B1BE0000000000000000000000000000000000000000000000000400000010C1224010C122406CFBB0BE68FCB0BE1012000028021D4020000000050000004862760100FEB0BE21FCB0BE65A3204065A320406BA3204001FDB0BE1012000000000000200000002B0000002D00000065A3204010C122400000B1BE08100000000000002000000070FBB0BE70FBB0BE0041770110C1224000000000D8FBB0BE88FBB0BE0010000090FBB0BE90FBB0BE01000000000000000A000000000000000A0000000100000000000000000000002000000026FCB0BE2000000028021D407C0BB1BE10FCB0BE070000000700000024FCB0BE05000000384877013B780C403848770190FCB0BE08000000384877013D48770105330C40000000000000000070DB76010100000048FCB0BE2594494070DB76010000000070DB760101000000B803770143954940050000004003770170DB760102000000";
        List listTLV = PBOC_TLV.decodingTLV(ss);
        Map mapTLV = PBOC_TLV.decodingTLV(listTLV);
//        String encodingList = PBOC_TLV.encodingTLV(listTLV);
        String encodingMap = PBOC_TLV.encodingTLV(mapTLV);
//        System.out.println(listTLV);
        System.out.println(mapTLV);
        
       
        
    }
}